<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
        content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>电网system</title>
    <link rel="stylesheet" type="text/css" href="__STATIC__/admin/layui/css/layui.css" />
    <link rel="stylesheet" type="text/css" href="__STATIC__/admin/css/admin.css" />
    <style>
        .stock_order_table .layui-input{ border: none;}
    </style>
</head>

<body>
    <form class="layui-form column-content-detail" method="post" action="{:url('project/balance_save')}" style="padding: 0px;">


                    <table id="table-list" class="layui-table balance_table" lay-size="sm" style="margin: 0px;">
                        <colgroup>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col>
                        </colgroup>
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>编号</th>
                                <th>供应商</th>
                                <th>单位</th>
                                <th>需求数量</th>
                                <th>类型</th>
                                <th>订货数量</th>
                                <th>工程调拨数量</th>
                                <th>结余调拨数量</th>
                                <th>已使用</th>
                                <th>仓库</th>
                                <th>结余</th>
                                <th>实际数量</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="list" id="vo"}
                            <tr>
                                <td rowspan="{$vo.count}">{$vo.goods_name}</td>
                                <td rowspan="{$vo.count}">{$vo.number}</td>
                                <td rowspan="{$vo.count}">{$vo.supply_name}</td>
                                <td rowspan="{$vo.count}">{$vo.unit}</td>
                                <td rowspan="{$vo.count}">{$vo.need}</td>
                                <td rowspan="{$vo.count}">{$buy_from[$vo.from]}</td>
                                <td rowspan="{$vo.count}">{$vo.buy_num}</td>
                                <td rowspan="{$vo.count}">{$vo.project_num}</td>
                                <td rowspan="{$vo.count}">{$vo.have_num}</td>
                                <td rowspan="{$vo.count}">{$vo.get}</td>
                                <td>{$vo.arr.0.stock_name}</td>
                                <td>{$vo.arr.0.have}</td>
                                <td style="padding: 0px;">
                                    <input type="number" min="0" data-id="{$vo.arr.0.id}" class="layui-input num" lay-verify="number|have_num" lay-verType="tips" style="border: none; text-align: center; padding: 0px;" value="" />
                                </td>
                            </tr>
                            {gt name="vo.count" value="1"}
                                {volist name="vo.arr" id="vo2" offset="1"}
                                <tr>
                                    <td>{$vo2.stock_name}</td>
                                    <td>{$vo2.have}</td>
                                    <td style="padding: 0px;">
                                        <input type="number" min="0" data-id="{$vo2.id}" class="layui-input num" lay-verify="number|have_num" lay-verType="tips" style="border: none; text-align: center; padding: 0px;" value="" />
                                    </td>
                                </tr>
                                {/volist}
                            {/gt}
                            {/volist}
                        </tbody>
                    </table>

                    



        <div style="padding: 10px; text-align: center;">
            <input type="hidden" class="project_id" value="{$project.id}"/>
            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="formDemo">立即提交</button>

        </div>
    </form>
    <script src="__STATIC__/admin/layui/layui.js" type="text/javascript" charset="utf-8"></script>
    <script src="__STATIC__/admin/js/common.js" type="text/javascript" charset="utf-8"></script>
    <script>
        layui.use(['form', 'jquery', 'laydate', 'layer', 'laypage', 'dialog', 'tool', 'element', 'layedit'], function () {
            var form = layui.form,
                layer = layui.layer,
                $ = layui.jquery,
                laypage = layui.laypage,
                laydate = layui.laydate,
                layedit = layui.layedit,
                tool = layui.tool,
                element = layui.element,
                dialog = layui.dialog;

            //自定义验证规则
            form.verify({
                have_num: function(value, item) {
                    var re = /^[0-9]+[0-9]*]*$/;
                    if (!re.test(value)){
                        return '请输入正整数';
                    }
                    
                }
            });
            
            

            form.on('submit(formDemo)', function (data) {

                var url = data.form.action;
                var project_id = $('.project_id').val();
                var num = [];
                $('.balance_table').find('tbody').find('tr').each(function(e){

                    var val = $(this).find('.num').val();
                    var id = $(this).find('.num').data('id');
                    if(val !== ''){
                        num.push({id: id, val: val});
                    }
                });

                if(num.length <= 0){
                    layer.msg('请填写实际的数量', { icon: 2, shade: 0.1, time: 1000 });
                    return false;
                }
                num = JSON.stringify(num);
                // console.log(num);
                // return false;
                loading = layer.load(2, {
                    shade: [0.2, '#000']
                });

                $.post(url, {project_id: project_id, num: num}, function (data) {
                    layer.close(loading);
                    console.dir(data);
                
                    if (data.error_code) {
                        layer.msg(data.msg, { icon: 2, shade: 0.1, time: 1000 }, function () {

                        });
                        return false;
                    }
                    layer.msg(data.msg, { icon: 1, shade: 0.1, time: 1000 }, function () {
                        parent.refresh();
                    });
                });

                return false;
            });




        });
    </script>
</body>

</html>