{include file="public/header" /}
<div class="wrap-container clearfix">
	<div class="column-content-detail">
		<!--- 头部搜索框 --->
		<div class="layui-card">
			<div class="layui-form">

				<div class="layui-form-item">
					<div class="layui-inline layui-form-pane">
						<div class="layui-inline">
							<button class="layui-btn search_btn1 layui-bg-blue"><i class="layui-icon layui-icon-add-1"></i>添加采购工程</button>
							<button class="layui-btn search_btn2 layui-bg-cyan"><i class="layui-icon layui-icon-ok"></i>确认生成采购单</button>
						</div>
					</div>
				</div>
				<form class="layui-form" lay-filter="search-form">
					<div class="layui-form-item">
						<div class="layui-inline layui-form-pane">
							<label class="layui-form-label">时间范围</label>
							<div class="layui-input-inline">
								<input type="text" name="create_time" style="width: 513px" value="" class="layui-input" id="time" readonly="readonly" placeholder="开始时间 - 结束时间">
							</div>
						</div>
					</div>

					<div class="layui-form-item">
						<div class="layui-inline layui-form-pane">
							<label class="layui-form-label">工程名称</label>
							<div class="layui-input-inline">
								<input type="text" name="search" placeholder="请输入工程名称..." autocomplete="off" class="layui-input search"/>
							</div>
						</div>

						<div class="layui-inline layui-form-pane">
							<label class="layui-form-label">业主</label>
							<div class="layui-input-inline">
								<select name="contract_id" lay-search="" lay-filter="select1">
									<option value="">全部</option>
									{volist name="data.contract" id="v"}
									<option value="{$v.id}">{$v.name}</option>
									{/volist}
								</select>
							</div>
						</div>

						<input type="hidden" name="buy_id" value="{$Request.get.id}"/>


						<div class="layui-inline">
							<div class="layui-input-inline">
								<button class="layui-btn layui-bg-blue btn_search"><i class="layui-icon layui-icon-search"></i>搜索</button>
								<button type="reset" class="layui-btn layui-btn-normal" id="empty"  lay-submit="" lay-filter="LAY-search">重置</button>
							</div>
						</div>
					</div>
				</form>
			</div>

		</div>
		<!--- 头部搜索框 --->

		<div class="layui-form" id="table-list">

			<table id="table" lay-filter="table"></table>

		</div>

	</div>
</div>
{include file="public/script" /}

<script type="text/html" id="template_status">
	{{# if(d.project_status == '待开工'){ }}
	<span class="layui-badge layui-bg-orange">{{d.project_status}}</span>
	{{# } }}
	{{# if(d.project_status == '已开工'){ }}
	<span class="layui-badge layui-bg-green">{{d.project_status}}</span>
	{{# } }}
	{{# if(d.project_status == '待结算'){ }}
	<span class="layui-badge layui-bg-cyan">{{d.project_status}}</span>
	{{# } }}
	{{# if(d.project_status == '已结算'){ }}
	<span class="layui-badge layui-bg-gray">{{d.project_status}}</span>
	{{# } }}
</script>


<script type="text/html" id="toolbar">
	<div class="layui-btn-container">
		<a class="layui-btn layui-btn-sm layui-bg-blue" lay-event="edit"><i class="layui-icon layui-icon-cart"></i>采购材料</a>
		<button class="layui-btn layui-btn-sm layui-bg-gray" lay-event="delete"><i class="layui-icon layui-icon-delete"></i>删除</button>
	</div>
</script>

<script>
	layui.use(['form', 'jquery', 'element', 'laydate', 'table'], function() {
		var form = layui.form,
				$ = layui.jquery,
				laydate = layui.laydate,
				table = layui.table;

		//日期范围
		laydate.render({
			elem: '#time'
			,range: '至'
			,type:'datetime'

		});

		// 确认搜索
		form.on('submit(search-form)',function (data) {
			table_reload();
			return false;
		});

		form.on('select(select1)', function(data){
			table_reload();
			return false;
		});

		// 表格刷新方法 带form数据
		table_reload = function(){
			var where = form.val("search-form");
			//执行重载
			table.reload('table', {
				where: where
			});
		};

		//第一个实例
		table.render({
			elem: '#table'
			,url: "{:url('buy/ajax_get_project_list')}"//数据接口
			// ,height: 'full-70'
			,page: false //开启分页
			,toolbar:true
			,limit:100000
			,loading:true
			,where:form.val("search-form")
			,text:{
				none:'暂无相关数据'
			}
			,cols: [[ //表头
				{type:'numbers', title: '序号', align:'center', fixed:'left', sort:true,width:90}
				,{field: 'project_name', title: '工程名称', sort: true, align:'center'}
				,{field: 'contract_name', title: '业主名称', sort: true, align:'center'}
				,{field: 'contract_number', title: '合同编号', sort: true, align:'center'}
				,{field: 'project_status', title: '状态', sort: true, align:'center', width:90, templet:'#template_status'}
				,{field: 'project_open_time', title: '开工时间',sort: true,  align:'center', width:180}
				,{field: 'create_time', title: '创建时间',sort: true,  align:'center', width:180}
				,{field: 'number', title: '操作', templet:'#toolbar', fixed:'right', align:'center', width:200}
			]],parseData: function(res){ //res 即为原始返回的数据
				return {
					"code": res.code, //解析接口状态
					"msg": res.msg, //解析提示文本
					"count": res.data.total, //解析数据长度
					"data": res.data.data //解析数据列表
				};
			},response: {
				statusCode: 200 //规定成功的状态码，默认：0
			}
		});

		table.on('tool(table)', function(obj) {
			if (obj.event == 'edit'){
				layer.open({
					type : 2,
					content:"{:url('buy/buy_info')}" + '?id=' + obj.data.id + '&buy_id=' + obj.data.buy_id + '&project_id=' + obj.data.project_id,
					title:['采购工程：' + obj.data.project_name  + '   业主：' + obj.data.contract_name, 'font-weight:bold'],
					btnAlign: 'c',
					area: ['100%', '100%'],
					anim: 5,
					isOutAnim:true,
				});
			}

			if (obj.event == 'delete'){
				layer.confirm('确定删除这条记录吗？', {icon: 3, title:'提示'}, function(index){
					var form_data = obj.data;
					$.post("{:url('buy/ajax_del_project')}",form_data, function(ret){
						if(ret.code == 200){
							layer.msg(ret.msg);
							table_reload();
						}else{
							layer.msg(ret.msg, function () {

							})
						}
					});
					layer.close(index);
				});
			}
		});


		$('.search_btn1').on('click',function () {
			layer.open({
				type : 2,
				content:"{:url('buy/project')}" + "?id={$Request.get.id}",
				title:'选择采购工程',
				btnAlign: 'c',
				area: ['95%', '95%'],
				shadeClose: true,
				anim: 5,
				isOutAnim:true,
				end:function(){
					table_reload();
				}
			});
		})

		// 确认生成采购单
		$('.search_btn2').on('click',function () {

			var form_data = {
				buy_id: "{$Request.get.id}",
			};
			$.post("{:url('buy/ajax_sure')}", form_data, function (ret) {
				if (ret.code == 200) {
					layer.msg(ret.msg);
				} else {
					layer.msg(ret.msg, function () {

					})
				}
			})
		})



	})
</script>
{include file="public/footer" /}